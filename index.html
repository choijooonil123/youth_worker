<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#10183a;--ink:#eaf0ff;--muted:#a7b3d4;--brand:#6aa6ff;--accent:#a176ff;--ok:#4cd97b;--danger:#ff6a6a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    header h1{margin:0;font-size:18px}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}

    .grid{display:grid;gap:12px;padding:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .col{background:var(--panel);border:1px solid #202a59;border-radius:14px;overflow:hidden}
    .col h3{margin:0;padding:12px 14px;background:linear-gradient(180deg,#1a2552,transparent);border-bottom:1px solid #202a59;font-size:15px}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:12px;margin:10px;cursor:pointer;font-size:14px;line-height:1.35}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    .score{font-size:36px;font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <h1>ì§ˆë¬¸ ë²„íŠ¼ Â· ê³¼ëª©ë³„ ì—´ ë°°ì¹˜ Â· ìŒì„±ë…¹ìŒ Â· ìë™ ìœ ì‚¬ë„</h1>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="toolbar">
        <button id="resetProgress" class="btn">ì§„í–‰ë„ ì´ˆê¸°í™”</button>
        <span id="statText" class="stat"></span>
      </div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- ë¬¸ì œ ë‹¤ì´ì–¼ë¡œê·¸ -->
  <dialog id="qd">
    <div class="dlg">
      <h2 id="qTitle">ì§ˆë¬¸</h2>
      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>
        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary" disabled>âœ… ë‹µë³€ì œì¶œ</button>
        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
      </div>
      <div>
        <div class="answer-box" id="userAnswer"></div>
      </div>
      <div id="result"></div>
    </div>
  </dialog>

  <script>
  // ===== ì „ì—­ ìƒíƒœ =====
  let raw = [];
  let data = [];// ë Œë”ë§ìš©(ì¸ë±ìŠ¤ ìœ ì§€)
  let practiceCount = 0; // ì´ 3íšŒ ì œí•œ
  let currentIdx = null; // í˜„ì¬ ë¬¸ì œ ì¸ë±ìŠ¤
  let mediaRecorder, audioChunks = [];
  let recognizing = false;

  // ===== ë°ì´í„° ë¡œë”© =====
  async function loadData(){
    try{
      const r = await fetch('youth_quiz_data.json',{cache:'no-store'});
      raw = await r.json();
    }catch(e){
      // ì—…ë¡œë“œ JSONì— subjectê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ fallback subject ì—†ì´ ì‚¬ìš©
      console.warn('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë¹ˆ ë°°ì—´ ì‚¬ìš©', e);
      raw = [];
    }
    // ë Œë”ìš© ë³µì œ
    data = raw.map((x,i)=>({ ...x, _idx:i }));
    renderGrid();
    updateStat();
  }

  // ===== ê·¸ë¦¬ë“œ ë Œë”: ê³¼ëª©(subject)=ì—´, question=ë²„íŠ¼(í–‰) =====
  function renderGrid(){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';

    // subject ë¬¶ê¸° (ì—†ìœ¼ë©´ 'ê¸°íƒ€')
    const groups = {};
    data.forEach((it)=>{
      const subj = (it.subject && String(it.subject).trim()) ? String(it.subject).trim() : 'ê¸°íƒ€';
      if(!groups[subj]) groups[subj] = [];
      groups[subj].push(it);
    });

    // ì—´ ìƒì„±
    Object.keys(groups).sort().forEach(subj =>{
      const col = document.createElement('div');
      col.className='col';
      const header = `<h3>${subj}</h3>`;
      const btns = groups[subj].map(q=>
        `<button class="qbtn" title="${escapeHtml(q.question)}" onclick="openQuestion(${q._idx})">${escapeHtml(q.question)}</button>`
      ).join('');
      col.innerHTML = header + btns;
      grid.appendChild(col);
    });
  }

  function updateStat(){
    const stat = document.getElementById('statText');
    stat.textContent = `ë‚¨ì€ ë¬¸í•­: ${data.length} / ì—°ìŠµíšŸìˆ˜: ${practiceCount}/3`;
  }

  // ===== ëª¨ë‹¬(ì§ˆë¬¸) =====
  function openQuestion(idx){
    if(practiceCount >= 3){ alert('3íšŒ ì—°ìŠµì„ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.'); return; }
    currentIdx = idx;
    const q = raw[idx];
    document.getElementById('qTitle').textContent = q.question;
    document.getElementById('userAnswer').textContent = '';
    document.getElementById('result').innerHTML = '';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('qd').showModal();
    speak(q.question);
  }
  function closeQuestion(){ document.getElementById('qd').close(); }

  // ===== ìŒì„± í•©ì„±(ì§ˆë¬¸ ì½ê¸°) =====
  function speak(txt){
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'ko-KR';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ===== ìŒì„± ë…¹ìŒ + (ë¸Œë¼ìš°ì € ì§€ì› ì‹œ) ì‹¤ì‹œê°„ ìŒì„± ì¸ì‹ =====
  async function startRecord(){
    // ë…¹ìŒ
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      // ë…¹ìŒ ì¢…ë£Œ í›„ ì œì¶œ ë²„íŠ¼ í™œì„±í™” (ì‹¤ì œ ì „ì‚¬ëŠ” Web Speechë¡œ ì²˜ë¦¬)
      document.getElementById('submitBtn').disabled = false;
    };
    mediaRecorder.start();

    // ì‹¤ì‹œê°„ ì „ì‚¬ (Chrome ê³„ì—´ì—ì„œë§Œ ë™ì‘)
    try{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(SR && !recognizing){
        const recog = new SR();
        recog.lang='ko-KR';
        recog.continuous=true;
        recog.interimResults=true;
        recognizing = true;
        let buff = '';
        recog.onresult = (ev)=>{
          let finalText = '';
          for(let i=ev.resultIndex;i<ev.results.length;i++){
            const res = ev.results[i];
            if(res.isFinal) finalText += res[0].transcript;
            else buff = res[0].transcript; // ì„ì‹œ í‘œì‹œ
          }
          const ua = document.getElementById('userAnswer');
          ua.textContent = (finalText || '') + (buff ? (' ' + buff) : '');
        };
        recog.onend = ()=>{ recognizing = false; };
        recog.start();
        // 6ì´ˆ í›„ ìë™ ì •ì§€ (í•„ìš” ì‹œ ì¡°ì •)
        setTimeout(()=>{ try{recog.stop();}catch{} }, 6000);
      }
    }catch(e){ console.warn('SpeechRecognition ì‚¬ìš© ë¶ˆê°€', e); }

    // 6ì´ˆ í›„ ìë™ ì¢…ë£Œ (í•„ìš” ì‹œ ì¡°ì •)
    setTimeout(()=>{ try{mediaRecorder.stop();}catch{} }, 6000);
  }

  // ===== ì œì¶œ(ìœ ì‚¬ë„ ê³„ì‚° í›„ ì •ë‹µ í‘œì‹œ) =====
  function submitAnswer(){
    const q = raw[currentIdx];
    const userTxt = (document.getElementById('userAnswer').textContent || '').trim();
    const gold = (q.answer || '').trim();
    const sim = jaccardSim(tokenize(userTxt), tokenize(gold));
    document.getElementById('result').innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style="opacity:.8;margin-bottom:6px">ì •ë‹µ ëª¨ë²”ë‹µì•ˆ</div>
          <div class="answer-box">${escapeHtml(gold)}</div>
        </div>
        <div class="score" style="margin-left:10px">${(sim*100).toFixed(1)}%</div>
      </div>`;
    practiceCount++; updateStat();
  }

  // ===== ìŠµë“ì™„ë£Œ(ëª©ë¡ì—ì„œ ì œê±°) =====
  function markLearned(){
    if(currentIdx==null) return;
    // data ë°°ì—´ì—ì„œ currentIdxë¥¼ ê°€ì§„ í•­ëª© ì œê±°
    data = data.filter(x => x._idx !== currentIdx);
    renderGrid(); updateStat(); closeQuestion();
  }

  // ===== ìœ í‹¸ =====
  function tokenize(t){
    return String(t||'')
      .replace(/[\n\r\t]/g,' ')
      .replace(/[^ê°€-í£a-zA-Z0-9 ]/g,' ')
      .split(/\s+/).filter(Boolean);
  }
  function jaccardSim(aTokens, bTokens){
    const A = new Set(aTokens), B = new Set(bTokens);
    let inter = 0; A.forEach(x=>{ if(B.has(x)) inter++; });
    const denom = (A.size + B.size - inter) || 1;
    return inter / denom;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
  document.getElementById('resetProgress').onclick = ()=>{
    practiceCount = 0; data = raw.map((x,i)=>({ ...x, _idx:i })); renderGrid(); updateStat();
  };
  document.getElementById('speakBtn').onclick = ()=>{ const q=raw[currentIdx]; if(q) speak(q.question); };
  document.getElementById('recordBtn').onclick = startRecord;
  document.getElementById('submitBtn').onclick = submitAnswer;
  document.getElementById('learnedBtn').onclick = markLearned;
  document.getElementById('closeBtn').onclick = closeQuestion;

  // ì „ì—­ ë…¸ì¶œ(ë²„íŠ¼ onclickìš©)
  window.openQuestion = openQuestion;

  // ì‹œì‘
  loadData();
  </script>
</body>
</html>
