<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;background:#f6f8fa;color:#222}
    header{padding:16px;display:flex;gap:10px;align-items:center;background:#1976d2;color:#fff}
    header h1{margin:0;font-size:18px}
    .wrap{max-width:900px;margin:20px auto;padding:10px}
    select{padding:6px 10px;border-radius:6px;font-size:15px}
    .qbtn{display:block;width:100%;text-align:left;padding:10px;margin:6px 0;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer}
    .qbtn:hover{background:#125ea6}
    dialog{width:min(700px,95vw);border:none;border-radius:10px;padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .btn{padding:8px 12px;border-radius:6px;cursor:pointer;border:none}
    .btn.primary{background:#1976d2;color:#fff}
    .btn.ok{background:#2e7d32;color:#fff}
    .btn.danger{background:#c62828;color:#fff}
    .answer-box{background:#f0f0f0;padding:10px;border-radius:6px;min-height:40px;white-space:pre-wrap}
    .score{font-size:24px;font-weight:bold;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <h1>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ</h1>
  </header>
  <div class="wrap">
    <div>
      <label>ê³¼ëª© ì„ íƒ: <select id="subjectSelect"></select></label>
    </div>
    <div id="qList"></div>
  </div>

  <dialog id="qd">
    <h2 id="qTitle">ì§ˆë¬¸</h2>
    <div class="row">
      <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ë“£ê¸°</button>
      <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
      <button id="submitBtn" class="btn primary" disabled>âœ… ì œì¶œ</button>
      <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
      <button id="closeBtn" class="btn danger">ë‹«ê¸°</button>
    </div>
    <div id="userAnswer" class="answer-box"></div>
    <div id="result"></div>
  </dialog>

  <script>
  let raw=[], data=[], currentIdx=null, practiceCount=0;

  async function loadData(){
    const r=await fetch('youth_quiz_data.json',{cache:'no-store'});
    raw=await r.json();
    data=raw.map((x,i)=>({...x,_idx:i}));
    renderSubjects();
  }

  function renderSubjects(){
    const sel=document.getElementById('subjectSelect');
    const subs={};
    data.forEach(it=>{const s=it.subject?it.subject:'ê¸°íƒ€'; if(!subs[s]) subs[s]=[]; subs[s].push(it);});
    sel.innerHTML='';
    Object.keys(subs).sort().forEach(s=>{
      const opt=document.createElement('option');
      opt.value=s; opt.textContent=s; sel.appendChild(opt);
    });
    sel.onchange=()=>renderQuestions(sel.value,subs[sel.value]);
    // ì´ˆê¸° í‘œì‹œ
    renderQuestions(Object.keys(subs)[0],subs[Object.keys(subs)[0]]);
  }

  function renderQuestions(subj, arr){
    const qList=document.getElementById('qList');
    qList.innerHTML=`<h3>${subj}</h3>`;
    arr.forEach(q=>{
      const b=document.createElement('button');
      b.className='qbtn';
      b.textContent=q.question;
      b.onclick=()=>openQuestion(q._idx);
      qList.appendChild(b);
    });
  }

  function openQuestion(idx){
    if(practiceCount>=3){alert('3íšŒ ì—°ìŠµ ì™„ë£Œ');return;}
    currentIdx=idx;
    const q=raw[idx];
    document.getElementById('qTitle').textContent=q.question;
    document.getElementById('userAnswer').textContent='';
    document.getElementById('result').innerHTML='';
    document.getElementById('submitBtn').disabled=true;
    document.getElementById('qd').showModal();
    speak(q.question);
  }
  function closeQuestion(){document.getElementById('qd').close();}

  function speak(t){const u=new SpeechSynthesisUtterance(t);u.lang='ko-KR';speechSynthesis.speak(u);}

  document.getElementById('recordBtn').onclick=async()=>{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const rec=new MediaRecorder(stream); let chunks=[];
    rec.ondataavailable=e=>chunks.push(e.data);
    rec.onstop=()=>{document.getElementById('userAnswer').textContent='(ë…¹ìŒ ì™„ë£Œ)';document.getElementById('submitBtn').disabled=false;};
    rec.start(); setTimeout(()=>rec.stop(),5000);
  };

  document.getElementById('submitBtn').onclick=()=>{
    const q=raw[currentIdx];
    const user=document.getElementById('userAnswer').textContent;
    const sim=similarity(user,q.answer);
    document.getElementById('result').innerHTML=`<div class='answer-box'>${q.answer}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;
    practiceCount++;
  };

  document.getElementById('learnedBtn').onclick=()=>{
    data=data.filter(x=>x._idx!==currentIdx);
    closeQuestion(); renderSubjects();
  };
  document.getElementById('closeBtn').onclick=closeQuestion;

  function similarity(a,b){
    const sa=new Set(a.split(' ')), sb=new Set(b.split(' ')); let inter=0;sa.forEach(w=>{if(sb.has(w))inter++;});
    return inter/(sa.size+sb.size-inter||1);
  }

  loadData();
  </script>
</body>
</html>
