<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    header h1{margin:0;font-size:18px}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}
    
    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}
    .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
    .counts{display:flex;gap:12px;align-items:center}
    .counts .pill{border-color:#2b3769}

    .grid{display:grid;gap:8px;padding:12px;grid-template-columns:1fr}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:10px;margin:4px 0;cursor:pointer;font-size:14px;line-height:1.32}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    textarea{width:100%;background:#0b1330;color:var(--ink);border:1px solid #212c5c;border-radius:14px;padding:8px;resize:vertical;min-height:80px}
    .score{font-size:36px;font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <h1>ë¡œê·¸ì¸ ë° í•™ìŠµ ì‹œìŠ¤í…œ</h1>
    <div class="spacer"></div>
    <div id="headerRank" class="pill" style="display:none"></div>
    <div id="headerUser" class="pill" style="display:none"></div>
    <button id="logoutBtn" class="btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <div class="wrap">
    <div id="loginPanel" class="panel">
      <div style="padding:20px;display:flex;flex-direction:column;gap:12px">
        <h2>ë¡œê·¸ì¸</h2>
        <input id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <button id="loginBtn" class="btn primary">ë¡œê·¸ì¸</button>
        <div id="rankList" style="margin-top:20px"></div>
      </div>
    </div>

    <div id="mainPanel" class="panel" style="display:none">
      <div class="toolbar">
        <button id="resetProgress" class="btn">ì´ˆê¸°í™”</button>
        <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
        <select id="subjectSelect"></select>
        <div class="counts">
          <div class="pill" id="countTotal">ì´ìˆ˜: 0</div>
          <div class="pill" id="countLearned">ìŠµë“ìˆ˜: 0</div>
        </div>
        <button id="addQuestionBtn" class="btn">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</button>
      </div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <dialog id="qd">
    <div class="dlg">
      <h2 id="qTitle">ì§ˆë¬¸</h2>
      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>
        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary">âœ… ë‹µë³€ì™„ë£Œ</button>
        <button id="addAnswerBtn" class="btn">â• ë‹µë³€ ì¶”ê°€</button>
        <button id="deleteQuestionBtn" class="btn danger">ğŸ—‘ ì§ˆë¬¸ ì‚­ì œ</button>
        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
      </div>
      <div>
        <div class="answer-box" id="userAnswer"></div>
      </div>
      <div id="result"></div>
      <div id="extraAnswers"></div>
    </div>
  </dialog>

  <script>
  let raw=[]; let data=[]; let currentIdx=null; let recognition; let currentUser=null; let scores={};

  const normSubj=s=>(s&&String(s).trim())?String(s).trim():'ê¸°íƒ€';
  function subjects(){return Array.from(new Set(raw.map(x=>normSubj(x.subject)))).sort();}

  const FALLBACK_DATA=[{subject:"ìƒ˜í”Œê³¼ëª©",question:"ì²­ì†Œë…„ìƒë‹´ì—ì„œ ë¼í¬ì˜ í•µì‹¬ì€?",answer:"ì§„ì •ì„±, ê³µê°, ì¡´ì¤‘ì„ í†µí•´ ì‹ ë¢°ê´€ê³„ë¥¼ í˜•ì„±"}];

  async function loadData(){ raw=FALLBACK_DATA.map(x=>({...x})); data=raw.map((x,i)=>({...x,_idx:i,answers:[x.answer]})); }

  function initSubjectSelect(){
    const sel=document.getElementById('subjectSelect');
    sel.innerHTML=subjects().map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    if(subjects().length){ sel.value=subjects()[0]; }
    sel.addEventListener('change',()=>{ renderBySubject(currentSubject()); updateCounts(currentSubject()); });
  }
  function currentSubject(){const sel=document.getElementById('subjectSelect');return sel&&sel.value?sel.value:(subjects()[0]||'ê¸°íƒ€');}

  function renderBySubject(subj){
    const grid=document.getElementById('grid');
    grid.innerHTML='';
    const list=data.filter(x=>normSubj(x.subject)===subj)
      .map(q=>`<button class="qbtn" onclick="openQuestion(${q._idx})">${escapeHtml(q.question)}</button>`).join('');
    grid.innerHTML=list||'<div style="padding:12px;opacity:.7">ì´ ê³¼ëª©ì˜ ë‚¨ì€ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  }

  function updateCounts(subj){
    const total=raw.filter(x=>normSubj(x.subject)===subj).length;
    const remain=data.filter(x=>normSubj(x.subject)===subj).length;
    const learned=Math.max(0,total-remain);
    document.getElementById('countTotal').textContent=`ì´ìˆ˜: ${total}`;
    document.getElementById('countLearned').textContent=`ìŠµë“ìˆ˜: ${learned}`;
    if(currentUser){ scores[currentUser]=learned; renderRanks(); updateHeaderUser(); }
  }{
    const total=raw.filter(x=>normSubj(x.subject)===subj).length;
    const remain=data.filter(x=>normSubj(x.subject)===subj).length;
    const learned=Math.max(0,total-remain);
    document.getElementById('countTotal').textContent=`ì´ìˆ˜: ${total}`;
    document.getElementById('countLearned').textContent=`ìŠµë“ìˆ˜: ${learned}`;
    if(currentUser){ scores[currentUser]=learned; renderRanks(); }
  }

  function openQuestion(idx){
    currentIdx=idx;
    const q=data.find(x=>x._idx===idx);
    document.getElementById('qTitle').textContent=q.question;
    document.getElementById('userAnswer').textContent='';
    document.getElementById('result').innerHTML='';
    document.getElementById('qd').showModal();
    renderExtraAnswers(q);
  }
  function closeQuestion(){if(recognition){recognition.stop();recognition=null;}document.getElementById('qd').close();}

  function speak(txt){const u=new SpeechSynthesisUtterance(txt);u.lang='ko-KR';speechSynthesis.cancel();speechSynthesis.speak(u);}

  document.getElementById('recordBtn').onclick=()=>{document.getElementById('userAnswer').textContent='(ë…¹ìŒì¤‘...)';};

  document.getElementById('submitBtn').onclick=()=>{
    const q=data.find(x=>x._idx===currentIdx);
    const user=document.getElementById('userAnswer').textContent;
    let bestAnswer=q.answers[0]; let bestSim=0;
    q.answers.forEach(ans=>{const sim=similarity(user,ans);if(sim>bestSim){bestSim=sim;bestAnswer=ans;}});
    document.getElementById('result').innerHTML=`<div class='answer-box'>${escapeHtml(bestAnswer)}</div><div class='score'>ìœ ì‚¬ë„ ${(bestSim*100).toFixed(1)}%</div>`;
    speak('ì •ë‹µì…ë‹ˆë‹¤. '+bestAnswer);
  };

  document.getElementById('learnedBtn').onclick=()=>{const subj=currentSubject();data=data.filter(x=>x._idx!==currentIdx);closeQuestion();renderBySubject(subj);updateCounts(subj);};
  document.getElementById('closeBtn').onclick=closeQuestion;

  document.getElementById('addAnswerBtn').onclick=()=>{
    const q=data.find(x=>x._idx===currentIdx);
    const newAns=prompt('ìƒˆë¡œìš´ ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”');
    if(newAns){q.answers.push(newAns);renderExtraAnswers(q);}
  };

  document.getElementById('deleteQuestionBtn').onclick=()=>{
    const subj=currentSubject();
    data=data.filter(x=>x._idx!==currentIdx);
    raw=raw.filter((_,i)=>i!==currentIdx);
    closeQuestion(); renderBySubject(subj); updateCounts(subj);
  };

  document.getElementById('addQuestionBtn').onclick=()=>{
    const subj=currentSubject();
    const q=prompt('ìƒˆ ì§ˆë¬¸ ì…ë ¥');
    const a=prompt('ì •ë‹µ ì…ë ¥');
    if(q&&a){const idx=raw.length; raw.push({subject:subj,question:q,answer:a}); data.push({_idx:idx,subject:subj,question:q,answers:[a]}); renderBySubject(subj); updateCounts(subj);} 
  };

  function renderExtraAnswers(q){
    const div=document.getElementById('extraAnswers');
    div.innerHTML='<h3>ì¶”ê°€ ë‹µë³€</h3>'+q.answers.map((ans,i)=>`<div><textarea readonly>${escapeHtml(ans)}</textarea><button onclick="deleteAnswer(${i})">ğŸ—‘ ì‚­ì œ</button></div>`).join('');
  }
  window.deleteAnswer=function(i){
    const q=data.find(x=>x._idx===currentIdx);
    q.answers.splice(i,1); renderExtraAnswers(q);
  };

  function similarity(a,b){const sa=new Set(String(a).split(/\s+/).filter(Boolean));const sb=new Set(String(b).split(/\s+/).filter(Boolean));let inter=0;sa.forEach(w=>{if(sb.has(w))inter++;});return inter/(sa.size+sb.size-inter||1);}
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

  function renderRanks(){
    const list=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
    const div=document.getElementById('rankList');
    if(div){ div.innerHTML='<h3>ìŠµë“ ìˆœìœ„</h3>'+list.map(([u,v],i)=>`<div>${i+1}. ${u}: ${v}</div>`).join(''); }
  }
  function getUserRank(u){ const list=Object.entries(scores).sort((a,b)=>b[1]-a[1]).map(([name])=>name); const idx=list.indexOf(u); return idx>=0? idx+1 : '-'; }
  function updateHeaderUser(){
    const uEl=document.getElementById('headerUser');
    const rEl=document.getElementById('headerRank');
    const lo=document.getElementById('logoutBtn');
    if(!currentUser){ uEl.style.display='none'; rEl.style.display='none'; lo.style.display='none'; return; }
    const rank=getUserRank(currentUser);
    const score=scores[currentUser]||0;
    uEl.textContent=`ì‚¬ìš©ì: ${currentUser}`; uEl.style.display='inline-block';
    rEl.textContent=`ìˆœìœ„: ${rank}ìœ„ Â· ìŠµë“ìˆ˜: ${score}`; rEl.style.display='inline-block';
    lo.style.display='inline-block';
  }
  function updateRanksAndHeader(){ renderRanks(); updateHeaderUser(); }. ${u}: ${v}</div>`).join('');}

  document.getElementById('loginBtn').onclick=()=>{
    const u=document.getElementById('username').value.trim();
    const p=document.getElementById('password').value.trim();
    if(!u||!p){alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
    currentUser=u;
    if(scores[currentUser]===undefined) scores[currentUser]=0;
    document.getElementById('loginPanel').style.display='none';
    document.getElementById('mainPanel').style.display='block';
    initSubjectSelect();
    renderBySubject(currentSubject());
    updateCounts(currentSubject());
    updateHeaderUser();
  };

  // ë¡œê·¸ì•„ì›ƒ
  document.getElementById('logoutBtn').onclick=()=>{
    currentUser=null;
    document.getElementById('mainPanel').style.display='none';
    document.getElementById('loginPanel').style.display='block';
    document.getElementById('headerUser').style.display='none';
    document.getElementById('headerRank').style.display='none';
    document.getElementById('logoutBtn').style.display='none';
    renderRanks();
  };

  // ì´ˆê¸°í™” ë²„íŠ¼ ë™ì‘: ë°ì´í„° ë¦¬ì…‹
  document.getElementById('resetProgress').onclick=()=>{
    loadData().then(()=>{initSubjectSelect();renderBySubject(currentSubject());updateCounts(currentSubject());});
  };

  loadData();
  updateRanksAndHeader();
  window.openQuestion=openQuestion;
  </script>
</body>
</html>
