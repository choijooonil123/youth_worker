<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    header h1{margin:0;font-size:18px}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}
    .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
    .counts{display:flex;gap:12px;align-items:center}
    .counts .pill{border-color:#2b3769}

    .grid{display:grid;gap:12px;padding:16px;grid-template-columns:1fr}
    .col{background:var(--panel);border:1px solid #202a59;border-radius:14px;overflow:hidden}
    .col h3{margin:0;padding:12px 14px;background:linear-gradient(180deg,#1a2552,transparent);border-bottom:1px solid #202a59;font-size:15px}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:12px;margin:10px;cursor:pointer;font-size:14px;line-height:1.35}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    .score{font-size:36px;font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <h1>ê³¼ëª© ì„ íƒ Â· ì§ˆë¬¸ ë²„íŠ¼ Â· ìŒì„±ë…¹ìŒ Â· ìë™ ìœ ì‚¬ë„</h1>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="toolbar">
        <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
        <select id="subjectSelect"></select>
        <div class="counts">
          <div class="pill" id="countTotal">ì´ìˆ˜: 0</div>
          <div class="pill" id="countLearned">ìŠµë“ìˆ˜: 0</div>
        </div>
        <button id="resetProgress" class="btn">ì§„í–‰ë„ ì´ˆê¸°í™”</button>
        <span id="statText" class="stat"></span>
      </div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <dialog id="qd">
    <div class="dlg">
      <h2 id="qTitle">ì§ˆë¬¸</h2>
      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>
        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary" disabled>âœ… ë‹µë³€ì œì¶œ</button>
        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
      </div>
      <div>
        <div class="answer-box" id="userAnswer"></div>
      </div>
      <div id="result"></div>
    </div>
  </dialog>

  <script>
  let raw = [];
  let data = [];// ì‘ì—…ìš©(ìŠµë“ì™„ë£Œ ì œê±° ë°˜ì˜)
  let currentIdx = null;
  let mediaRecorder, audioChunks = [];

  // ===== ìœ í‹¸ =====
  const normSubj = (s)=> (s && String(s).trim()) ? String(s).trim() : 'ê¸°íƒ€';
  const subjects = ()=> Array.from(new Set(raw.map(x=>normSubj(x.subject)))).sort();

  async function loadData(){
    try{ const r = await fetch('youth_quiz_data.json',{cache:'no-store'}); raw = await r.json(); }
    catch(e){ raw=[]; }
    data = raw.map((x,i)=>({ ...x, _idx:i }));
    initSubjectSelect();
    renderBySubject(currentSubject());
    updateCounts(currentSubject());
    updateGlobalStat();
  }

  function initSubjectSelect(){
    const sel = document.getElementById('subjectSelect');
    sel.innerHTML = subjects().map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    // ê¸°ë³¸ ì„ íƒì€ ì²« ë²ˆì§¸ ê³¼ëª©
    if(subjects().length){ sel.value = subjects()[0]; }
    sel.addEventListener('change', ()=>{ renderBySubject(currentSubject()); updateCounts(currentSubject()); });
  }

  function currentSubject(){
    const sel = document.getElementById('subjectSelect');
    return sel && sel.value ? sel.value : (subjects()[0]||'ê¸°íƒ€');
  }

  function renderBySubject(subj){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const col = document.createElement('div');
    col.className = 'col';
    const list = data.filter(x=> normSubj(x.subject)===subj)
                     .map(q=>`<button class="qbtn" onclick="openQuestion(${q._idx})" title="${escapeHtml(q.question)}">${escapeHtml(q.question)}</button>`)
                     .join('');
    col.innerHTML = `<h3>${escapeHtml(subj)}</h3>` + (list || `<div style="padding:12px;opacity:.7">ì´ ê³¼ëª©ì˜ ë‚¨ì€ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`);
    grid.appendChild(col);
  }

  function updateCounts(subj){
    const total = raw.filter(x=> normSubj(x.subject)===subj).length;
    const remain = data.filter(x=> normSubj(x.subject)===subj).length;
    const learned = Math.max(0, total - remain);
    document.getElementById('countTotal').textContent = `ì´ìˆ˜: ${total}`;
    document.getElementById('countLearned').textContent = `ìŠµë“ìˆ˜: ${learned}`;
  }

  function updateGlobalStat(){
    // ì „ì²´ ë‚¨ì€ ë¬¸í•­ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
    document.getElementById('statText').textContent = `ì „ì²´ ë‚¨ì€ ë¬¸í•­: ${data.length}`;
  }

  // ===== ëª¨ë‹¬(ì§ˆë¬¸) =====
  function openQuestion(idx){
    currentIdx = idx;
    const q = raw[idx];
    document.getElementById('qTitle').textContent = q.question;
    document.getElementById('userAnswer').textContent = '';
    document.getElementById('result').innerHTML = '';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('qd').showModal();
    speak(q.question);
  }
  function closeQuestion(){ document.getElementById('qd').close(); }

  // ===== ìŒì„± í•©ì„± =====
  function speak(txt){ const u = new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }

  // ===== ë…¹ìŒ =====
  document.getElementById('recordBtn').onclick = async ()=>{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioChunks=[]; const mr = new MediaRecorder(stream); mediaRecorder = mr;
    mr.ondataavailable = e=> audioChunks.push(e.data);
    mr.onstop = ()=>{ document.getElementById('userAnswer').textContent='(ë…¹ìŒ ì™„ë£Œ)'; document.getElementById('submitBtn').disabled=false; };
    mr.start(); setTimeout(()=>{ try{mr.stop();}catch{} }, 5000);
  };

  // ===== ì œì¶œ =====
  document.getElementById('submitBtn').onclick = ()=>{
    const q = raw[currentIdx];
    const user = document.getElementById('userAnswer').textContent;
    const sim = similarity(user, q.answer);
    document.getElementById('result').innerHTML = `<div class='answer-box'>${escapeHtml(q.answer)}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;
    speak('ì •ë‹µì…ë‹ˆë‹¤. ' + q.answer);
  };

  // ===== ìŠµë“ì™„ë£Œ =====
  document.getElementById('learnedBtn').onclick = ()=>{
    const subj = currentSubject();
    data = data.filter(x=> x._idx !== currentIdx);
    closeQuestion();
    renderBySubject(subj);
    updateCounts(subj);
    updateGlobalStat();
  };
  document.getElementById('closeBtn').onclick = closeQuestion;

  // ===== ê°„ë‹¨ ìœ ì‚¬ë„ =====
  function similarity(a,b){
    const sa=new Set(String(a).split(/\s+/).filter(Boolean));
    const sb=new Set(String(b).split(/\s+/).filter(Boolean));
    let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
    return inter/(sa.size+sb.size-inter||1);
  }
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

  // ===== ì§„í–‰ë„ ì´ˆê¸°í™” =====
  document.getElementById('resetProgress').onclick = ()=>{
    data = raw.map((x,i)=>({ ...x, _idx:i }));
    renderBySubject(currentSubject());
    updateCounts(currentSubject());
    updateGlobalStat();
  };

  // ì‹œì‘
  loadData();
  // ì „ì—­ ë…¸ì¶œ
  window.openQuestion = openQuestion;
  </script>
</body>
</html>
