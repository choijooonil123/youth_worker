<script>
  let raw = [];
  let data = [];// 작업용(습득완료 제거 반영)
  let currentIdx = null;
  let mediaRecorder, audioChunks = [];
  let recog = null;           // Web Speech
  let recognizing = false;
  let recogFinalText = '';    // 누적 확정 텍스트

  // ===== 유틸 =====
  const normSubj = (s)=> (s && String(s).trim()) ? String(s).trim() : '기타';
  const subjects = ()=> Array.from(new Set(raw.map(x=>normSubj(x.subject)))).sort();

  async function loadData(){
    try{ const r = await fetch('youth_quiz_data.json',{cache:'no-store'}); raw = await r.json(); }
    catch(e){ raw=[]; }
    data = raw.map((x,i)=>({ ...x, _idx:i }));
    initSubjectSelect();
    renderBySubject(currentSubject());
    updateCounts(currentSubject());
    updateGlobalStat();
  }

  function initSubjectSelect(){
    const sel = document.getElementById('subjectSelect');
    sel.innerHTML = subjects().map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    if(subjects().length){ sel.value = subjects()[0]; }
    sel.addEventListener('change', ()=>{ renderBySubject(currentSubject()); updateCounts(currentSubject()); });
  }

  function currentSubject(){
    const sel = document.getElementById('subjectSelect');
    return sel && sel.value ? sel.value : (subjects()[0]||'기타');
  }

  function renderBySubject(subj){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const col = document.createElement('div');
    col.className = 'col';
    const list = data.filter(x=> normSubj(x.subject)===subj)
                     .map(q=>`<button class="qbtn" onclick="openQuestion(${q._idx})" title="${escapeHtml(q.question)}">${escapeHtml(q.question)}</button>`)
                     .join('');
    col.innerHTML = `<h3>${escapeHtml(subj)}</h3>` + (list || `<div style="padding:12px;opacity:.7">이 과목의 남은 문항이 없습니다.</div>`);
    grid.appendChild(col);
  }

  function updateCounts(subj){
    const total = raw.filter(x=> normSubj(x.subject)===subj).length;
    const remain = data.filter(x=> normSubj(x.subject)===subj).length;
    const learned = Math.max(0, total - remain);
    document.getElementById('countTotal').textContent = `총수: ${total}`;
    document.getElementById('countLearned').textContent = `습득수: ${learned}`;
  }

  function updateGlobalStat(){
    document.getElementById('statText').textContent = `전체 남은 문항: ${data.length}`;
  }

  // ===== 모달(질문) =====
  function openQuestion(idx){
    currentIdx = idx;
    const q = raw[idx];
    document.getElementById('qTitle').textContent = q.question;
    document.getElementById('userAnswer').textContent = '';
    document.getElementById('result').innerHTML = '';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('qd').showModal();
    speak(q.question);
  }
  function closeQuestion(){
    stopRecognition();
    stopRecording();
    document.getElementById('qd').close();
  }

  // ===== 음성 합성 =====
  function speak(txt){ const u = new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }

  // ===== 녹음 + (가능하면) 실시간 인식 =====
  document.getElementById('recordBtn').onclick = async ()=>{
    // 1) 녹음
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioChunks=[]; mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e=> audioChunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      // 인식 미지원 브라우저면 안내, 지원이면 최종 텍스트를 중복 제거해 정리
      if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
        document.getElementById('userAnswer').textContent = '(브라우저가 실시간 음성 인식을 지원하지 않습니다)';
      } else {
        const cleaned = dedupeText(recogFinalText || document.getElementById('userAnswer').textContent);
        document.getElementById('userAnswer').textContent = cleaned.trim();
      }
      document.getElementById('submitBtn').disabled=false;
    };
    mediaRecorder.start();

    // 2) 실시간 인식(Web Speech API)
    startRecognition();

    // 3) 자동 종료(원하면 시간 조정)
    setTimeout(()=>{ stopRecognition(); stopRecording(); }, 8000);
  };

  function stopRecording(){
    try{ if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); }catch{}
  }

  function startRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ return; }
    stopRecognition();
    recog = new SR();
    recog.lang = 'ko-KR';
    recog.continuous = true;
    recog.interimResults = true;
    recognizing = true; recogFinalText='';

    recog.onresult = (ev)=>{
      let interim = '';
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        const res = ev.results[i];
        if(res.isFinal){ recogFinalText += res[0].transcript + ' '; }
        else { interim += res[0].transcript + ' '; }
      }
      const live = (recogFinalText + ' ' + interim).trim();
      // 실시간 화면 표시 + 즉시 중복어 제거
      document.getElementById('userAnswer').textContent = dedupeText(live);
    };
    recog.onend = ()=>{ recognizing=false; };
    try{ recog.start(); }catch{}
  }

  function stopRecognition(){
    try{ if(recog && recognizing){ recog.stop(); } }catch{}
    recognizing = false;
  }

  // ===== 제출 =====
  document.getElementById('submitBtn').onclick = ()=>{
    const q = raw[currentIdx];
    const user = document.getElementById('userAnswer').textContent;
    const sim = similarity(user, q.answer);
    document.getElementById('result').innerHTML = `<div class='answer-box'>${escapeHtml(q.answer)}</div><div class='score'>유사도 ${(sim*100).toFixed(1)}%</div>`;
    speak('정답입니다. ' + q.answer);
  };

  // ===== 습득완료 =====
  document.getElementById('learnedBtn').onclick = ()=>{
    const subj = currentSubject();
    data = data.filter(x=> x._idx !== currentIdx);
    closeQuestion();
    renderBySubject(subj);
    updateCounts(subj);
    updateGlobalStat();
  };
  document.getElementById('closeBtn').onclick = closeQuestion;

  // ===== 간단 유사도 & 텍스트 정리 =====
  function similarity(a,b){
    const sa=new Set(String(a).split(/\s+/).filter(Boolean));
    const sb=new Set(String(b).split(/\s+/).filter(Boolean));
    let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
    return inter/(sa.size+sb.size-inter||1);
  }
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

  // 연속 중복 토큰 + 2-gram 반복 제거
  function dedupeText(t){
    const tokens = String(t||'').replace(/[\\n\\t]+/g,' ').replace(/\\s+/g,' ').trim().split(' ');
    if(tokens.length<=1) return tokens.join(' ');
    const out=[]; let prev='';
    for(const tok of tokens){ if(tok!==prev){ out.push(tok); prev=tok; } }
    for(let i=0;i<out.length-3;i++){
      const a=out[i] + ' ' + out[i+1];
      const b=out[i+2] + ' ' + out[i+3];
      if(a===b){ out.splice(i+2,2); i--; }
    }
    return out.join(' ');
  }

  // ===== 진행도 초기화 =====
  document.getElementById('resetProgress').onclick = ()=>{
    data = raw.map((x,i)=>({ ...x, _idx:i }));
    renderBySubject(currentSubject());
    updateCounts(currentSubject());
    updateGlobalStat();
  };

  // 시작
  loadData();
  // 전역 노출
  window.openQuestion = openQuestion;
</script>
