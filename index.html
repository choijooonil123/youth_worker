<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}
    .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
    .counts{display:flex;gap:12px;align-items:center}
    .counts .pill{border-color:#2b3769}

    .grid{display:grid;gap:8px;padding:12px;grid-template-columns:1fr}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:10px;margin:4px 0;cursor:pointer;font-size:14px;line-height:1.32}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    textarea{width:100%;background:#0b1330;color:var(--ink);border:1px solid #212c5c;border-radius:14px;padding:8px;resize:vertical;min-height:80px}
    .score{font-size:36px;font-weight:800}
    .muted{color:#a7b3d4;opacity:.85}
  </style>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <div class="spacer"></div>
    <div id="headerRank" class="pill" style="display:none"></div>
    <div id="headerUser" class="pill" style="display:none"></div>
    <button id="logoutBtn" class="btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <div class="wrap">
    <!-- ë¡œê·¸ì¸ íŒ¨ë„ -->
    <div id="loginPanel" class="panel">
      <div style="padding:20px;display:flex;flex-direction:column;gap:12px">
        <h2>ë¡œê·¸ì¸</h2>
        <input id="username" placeholder="ì‚¬ìš©ì ì´ë¦„" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <button id="loginBtn" class="btn primary">ë¡œê·¸ì¸ / ê°€ì…</button>
        <div class="muted">ë™ì¼í•œ ì•„ì´ë””ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ë©´ ì´ì „ì˜ í•™ìŠµ ì§„í–‰ì´ ì´ì–´ì§‘ë‹ˆë‹¤.</div>
        <div id="rankTableWrap" style="margin-top:20px">
          <h3>í•™ìŠµ ìˆœìœ„</h3>
          <table style="width:100%;border-collapse:collapse;font-size:14px">
            <thead><tr><th style="text-align:left;border-bottom:1px solid #1f2a55;padding:8px">ìˆœìœ„</th><th style="text-align:left;border-bottom:1px solid #1f2a55;padding:8px">ì‚¬ìš©ì</th><th style="text-align:left;border-bottom:1px solid #1f2a55;padding:8px">ìŠµë“ìˆ˜</th></tr></thead>
            <tbody id="rankTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ë©”ì¸ íŒ¨ë„ -->
    <div id="mainPanel" class="panel" style="display:none">
      <div class="toolbar">
        <button id="resetProgress" class="btn">ì´ˆê¸°í™”</button>
        <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
        <select id="subjectSelect"></select>
        <div class="counts">
          <div class="pill" id="countTotal">ì´ìˆ˜: 0</div>
          <div class="pill" id="countLearned">ìŠµë“ìˆ˜: 0</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="addQ" placeholder="ìƒˆ ì§ˆë¬¸" style="border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:240px"/>
          <input id="addA" placeholder="ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)" style="border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:240px"/>
          <button id="addBtn" class="btn">+ ì¶”ê°€</button>
        </div>
      </div>
      <div id="bootNotice" class="muted" style="padding:8px 14px"></div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- ì§ˆë¬¸ ëª¨ë‹¬ -->
  <dialog id="qd">
    <div class="dlg">
      <h2 id="qTitle">ì§ˆë¬¸</h2>
      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>
        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary">âœ… ë‹µë³€ì™„ë£Œ</button>
        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="deleteQuestionBtn" class="btn danger">ğŸ—‘ ì§ˆë¬¸ ì‚­ì œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
      </div>
      <div><div class="answer-box" id="userAnswer"></div></div>
      <div id="result"></div>

      <div style="margin-top:10px">
        <h3 style="margin:10px 0 6px">ì´ ë¬¸í•­ì˜ ì •ë‹µ(ì—¬ëŸ¬ ê°œ ê´€ë¦¬)</h3>
        <div id="answerList" class="answer-box" style="min-height:0"></div>
        <div class="row" style="align-items:flex-start">
          <textarea id="newAns" rows="4" placeholder="ì´ ë¬¸í•­ì— ìƒˆë¡œìš´ ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <button id="addAnsBtn" class="btn">ì •ë‹µ ì¶”ê°€</button>
        </div>
        <div class="muted">ë¼ë””ì˜¤ë¡œ ì„ íƒëœ ì •ë‹µì´ ì´í›„ ë¹„êµ ë° ìŒì„± ì¶œë ¥ì— ì‚¬ìš©ë©ë‹ˆë‹¤. (ğŸ—‘ë¡œ ê°œë³„ ì •ë‹µ ì‚­ì œ ê°€ëŠ¥)</div>
      </div>
    </div>
  </dialog>

  <script>
  /* ===== ì €ì¥ì†Œ í‚¤ ===== */
  const LS_USERS_KEY='yj_users_v2';          // { username: { pass: '***' } }
  const LS_PROGRESS_KEY='yj_progress_v2';    // { username: { learnedIds: [...] } }

  /* ===== ì „ì—­ ìƒíƒœ ===== */
  let raw = [];     // ì›ë³¸(ì „ì²´ ë¬¸í•­)
  let data = [];    // í™”ë©´ìš©(í•„í„°/ê°€ê³µ)
  let currentIdx = null; // í˜„ì¬ ë³´ëŠ” ë¬¸í•­ì˜ ë‚´ë¶€ index(_idx)
  let recognition = null;
  let currentUser = null;

  /* ===== ìœ í‹¸ ===== */
  const normSubj = s => (s && String(s).trim()) ? String(s).trim() : 'ê¸°íƒ€';
  const qId = q => `${normSubj(q.subject)}::${q.question}`; // ë¬¸í•­ ê³ ìœ  ë¬¸ìì—´ ID
  const escapeHtml = s => String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  /* ===== ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìœ í‹¸ ===== */
  const loadUsers = () => { try { return JSON.parse(localStorage.getItem(LS_USERS_KEY)||'{}'); } catch { return {}; } };
  const saveUsers = obj => localStorage.setItem(LS_USERS_KEY, JSON.stringify(obj));
  const loadProgress = () => { try { return JSON.parse(localStorage.getItem(LS_PROGRESS_KEY)||'{}'); } catch { return {}; } };
  const saveProgress = obj => localStorage.setItem(LS_PROGRESS_KEY, JSON.stringify(obj));

  const ensureUser = (username, password) => {
    const users = loadUsers();
    if (!users[username]) users[username] = { pass: password };
    saveUsers(users);
    const prog = loadProgress();
    if (!prog[username]) prog[username] = { learnedIds: [] };
    saveProgress(prog);
  };
  const authUser = (username, password) => {
    const users = loadUsers();
    if (!users[username]) return { ok: true, newUser: true }; // ì‹ ê·œ ê°€ì… í—ˆìš©
    if (users[username].pass === password) return { ok: true, newUser: false };
    return { ok: false, msg: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' };
  };

  /* ===== ë°ì´í„° ë¡œë“œ ===== */
  const FALLBACK_DATA = [
    { subject: 'ìƒ˜í”Œê³¼ëª©', question: 'ì²­ì†Œë…„ìƒë‹´ì—ì„œ ë¼í¬ì˜ í•µì‹¬ì€?', answer: 'ì§„ì •ì„±, ê³µê°, ì¡´ì¤‘ì„ í†µí•´ ì‹ ë¢°ê´€ê³„ë¥¼ í˜•ì„±' },
    { subject: 'ìƒ˜í”Œê³¼ëª©', question: 'ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?', answer: 'ë³´í˜¸, ì°¸ì—¬, ë°œë‹¬' }
  ];

  async function loadData() {
    const notice = document.getElementById('bootNotice');
    try {
      notice.textContent = 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      const r = await fetch('youth_quiz_data.json', { cache: 'no-store' });
      if (!r.ok) throw new Error('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨');
      raw = await r.json();
      if (!Array.isArray(raw) || raw.length === 0) throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤');
      notice.textContent = '';
    } catch (e) {
      console.warn('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œì‘', e);
      raw = FALLBACK_DATA.map(x => ({ ...x }));
      notice.textContent = 'âš ï¸ youth_quiz_data.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ì—¬ ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.';
    }
    // ì •ê·œí™”: answers ë°°ì—´/active ì£¼ì… + _idx + _id
    raw = raw.map((x, i) => ({
      ...x,
      _idx: i,
      _id: qId(x),
      answers: Array.isArray(x.answers) ? x.answers.filter(Boolean) : [(x.answer||'')].filter(Boolean),
      active: (typeof x.active === 'number' ? x.active : 0)
    }));
    applyUserFilterAndRender();
  }

  /* ===== ì‚¬ìš©ì ì§„í–‰ ë°˜ì˜ í›„ ë Œë” ===== */
  function applyUserFilterAndRender() {
    const prog = loadProgress();
    const learned = currentUser ? new Set((prog[currentUser]?.learnedIds)||[]) : new Set();
    data = raw.map(x => ({ ...x })) // ë³µì œ
              .filter(q => !learned.has(q._id));
    initSubjectSelect();
    renderBySubject(currentSubject());
    updateCounts(currentSubject());
    updateHeaderUser();
    updateLeaderboardTable();
  }

  /* ===== ê³¼ëª© ì„ íƒ ===== */
  function subjects() { return Array.from(new Set(raw.map(x => normSubj(x.subject)))).sort(); }
  function initSubjectSelect() {
    const sel = document.getElementById('subjectSelect');
    sel.innerHTML = subjects().map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    if (subjects().length) sel.value = subjects()[0];
    sel.onchange = () => { renderBySubject(currentSubject()); updateCounts(currentSubject()); };
    document.getElementById('addBtn').onclick = addNewQA;
  }
  function currentSubject() {
    const sel = document.getElementById('subjectSelect');
    return sel && sel.value ? sel.value : (subjects()[0]||'ê¸°íƒ€');
  }

  function renderBySubject(subj) {
    const grid = document.getElementById('grid');
    const list = data.filter(x=>normSubj(x.subject)===subj)
      .map(q=>`<button class="qbtn" onclick="openQuestion(${q._idx})" title="${escapeHtml(q.question)}">${escapeHtml(q.question)}</button>`).join('');
    grid.innerHTML = list || `<div style="padding:12px;opacity:.7">ì´ ê³¼ëª©ì˜ ë‚¨ì€ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  function updateCounts(subj) {
    const prog = loadProgress();
    const learned = currentUser ? new Set((prog[currentUser]?.learnedIds)||[]) : new Set();
    const total = raw.filter(x=>normSubj(x.subject)===subj).length;
    const learnedCount = raw.filter(x=>normSubj(x.subject)===subj && learned.has(x._id)).length;
    document.getElementById('countTotal').textContent = `ì´ìˆ˜: ${total}`;
    document.getElementById('countLearned').textContent = `ìŠµë“ìˆ˜: ${learnedCount}`;
  }

  /* ===== ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ ===== */
  function updateHeaderUser() {
    const headerUser = document.getElementById('headerUser');
    const headerRank = document.getElementById('headerRank');
    const btnLogout  = document.getElementById('logoutBtn');
    if (!currentUser) {
      headerUser.style.display='none'; headerRank.style.display='none'; btnLogout.style.display='none';
      return;
    }
    const prog = loadProgress();
    const learnedCnt = (prog[currentUser]?.learnedIds||[]).length;
    // ìˆœìœ„ ê³„ì‚°
    const users = Object.keys(loadUsers());
    const ranks = users.map(u=>({u, c:(prog[u]?.learnedIds||[]).length}))
                       .sort((a,b)=>b.c-a.c);
    const rankIndex = ranks.findIndex(r=>r.u===currentUser);
    const rankText = (rankIndex>=0) ? `${rankIndex+1}ìœ„` : '-';
    headerUser.textContent = `ì‚¬ìš©ì: ${currentUser}`;
    headerRank.textContent = `ìˆœìœ„: ${rankText} Â· ìŠµë“ìˆ˜: ${learnedCnt}`;
    headerUser.style.display='inline-block';
    headerRank.style.display='inline-block';
    btnLogout.style.display='inline-block';
  }

  function updateLeaderboardTable() {
    const prog = loadProgress();
    const tbody = document.getElementById('rankTbody');
    const users = Object.keys(loadUsers());
    const sorted = users.map(u=>({u, c:(prog[u]?.learnedIds||[]).length}))
                        .sort((a,b)=>b.c-a.c).slice(0,50);
    tbody.innerHTML = sorted.map((r,i)=>`<tr>
      <td style="border-bottom:1px solid #1f2a55;padding:8px">${i+1}</td>
      <td style="border-bottom:1px solid #1f2a55;padding:8px">${r.u}</td>
      <td style="border-bottom:1px solid #1f2a55;padding:8px">${r.c}</td>
    </tr>`).join('') || `<tr><td colspan="3" style="padding:8px;opacity:.7">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>`;
  }

  document.getElementById('loginBtn').onclick = () => {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if(!u || !p) { alert('ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    const r = authUser(u,p);
    if(!r.ok) { alert(r.msg); return; }
    ensureUser(u,p);
    currentUser = u;
    document.getElementById('loginPanel').style.display='none';
    document.getElementById('mainPanel').style.display='block';
    applyUserFilterAndRender();
  };

  document.getElementById('logoutBtn').onclick = () => {
    currentUser = null;
    document.getElementById('mainPanel').style.display='none';
    document.getElementById('loginPanel').style.display='block';
    updateLeaderboardTable();
    updateHeaderUser();
  };

  /* ===== ì´ˆê¸°í™”(í˜„ì¬ ì‚¬ìš©ì ì§„í–‰ë„ ë¦¬ì…‹) ===== */
  document.getElementById('resetProgress').onclick = () => {
    if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
    const prog = loadProgress();
    prog[currentUser] = { learnedIds: [] };
    saveProgress(prog);
    applyUserFilterAndRender();
  };

  /* ===== ì§ˆë¬¸ ì¶”ê°€/ì‚­ì œ ===== */
  function addNewQA(){
    const subj = currentSubject();
    const q = document.getElementById('addQ').value.trim();
    const a = document.getElementById('addA').value.trim();
    if(!q || !a){ alert('ì§ˆë¬¸ê³¼ ì •ë‹µì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    const idx = raw.length;
    const item = { subject: subj, question: q, answers: [a], active: 0, _idx: idx, _id: `${normSubj(subj)}::${q}` };
    raw.push(item);
    // í˜„ì¬ ì‚¬ìš©ì ì§„í–‰ ë°˜ì˜ëœ dataì—ë„ ì¶”ê°€ (ì•„ì§ í•™ìŠµ ì „ì´ë¯€ë¡œ í‘œì‹œ)
    data.push({...item});
    document.getElementById('addQ').value='';
    document.getElementById('addA').value='';
    renderBySubject(subj); updateCounts(subj);
  }

  document.getElementById('deleteQuestionBtn').onclick = () => {
    const subj = currentSubject();
    const target = raw.find(x=>x._idx===currentIdx);
    if(!target){ closeQuestion(); return; }
    // raw/dataì—ì„œ ì œê±°
    raw = raw.filter(x=>x._idx!==currentIdx);
    data = data.filter(x=>x._idx!==currentIdx);
    closeQuestion();
    renderBySubject(subj);
    updateCounts(subj);
  };

  /* ===== ì§ˆë¬¸ ëª¨ë‹¬ ===== */
  function openQuestion(idx){
    currentIdx = idx;
    const q = raw.find(x=>x._idx===idx);
    if(!q){ return; }
    document.getElementById('qTitle').textContent = q.question;
    document.getElementById('userAnswer').textContent = '';
    document.getElementById('result').innerHTML = '';
    renderAnswerList();
    document.getElementById('qd').showModal();
    speak(q.question);
  }
  function closeQuestion(){ if(recognition){ recognition.stop(); recognition=null; } document.getElementById('qd').close(); }
  window.openQuestion = openQuestion;

  /* ===== ìŒì„± í•©ì„± ===== */
  function speak(txt){ const u = new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
  document.getElementById('speakBtn').onclick = () => {
    const q = raw.find(x=>x._idx===currentIdx); if(q) speak(q.question);
  };

  /* ===== ìŒì„± ì¸ì‹(STT) ===== */
  function startRecognition(){
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!window.SpeechRecognition){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.continuous = true;
    recognition.interimResults = true;
    let finalTranscript = '';
    recognition.onresult = (event)=>{
      let interim = '';
      for(let i=event.resultIndex;i<event.results.length;i++){
        const t = event.results[i][0].transcript;
        if(event.results[i].isFinal){ finalTranscript += t + ' '; }
        else { interim += t; }
      }
      const combined = (finalTranscript + interim).trim();
      document.getElementById('userAnswer').textContent = combined;
    };
    recognition.start();
  }
  document.getElementById('recordBtn').onclick = ()=>{
    document.getElementById('userAnswer').textContent = '(ë…¹ìŒì¤‘...)';
    startRecognition();
  };

  /* ===== ë‹µë³€ì™„ë£Œ ===== */
  document.getElementById('submitBtn').onclick = ()=>{
    const q = raw.find(x=>x._idx===currentIdx);
    const user = document.getElementById('userAnswer').textContent;
    const gold = q.answers[q.active||0] || '';
    const sim = similarity(user, gold);
    document.getElementById('result').innerHTML = `<div class='answer-box'>${escapeHtml(gold)}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;
    speak('ì •ë‹µì…ë‹ˆë‹¤. ' + gold);
  };

  /* ===== ì •ë‹µ(ì—¬ëŸ¬ ê°œ) ê´€ë¦¬ ===== */
  function renderAnswerList(){
    const box = document.getElementById('answerList');
    const q = raw.find(x=>x._idx===currentIdx);
    box.innerHTML = (q.answers||[]).map((ans,i)=>{
      const checked = (q.active||0)===i ? 'checked' : '';
      return `<label style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
        <input type="radio" name="ansPick" value="${i}" ${checked} style="margin-top:4px"/>
        <div style="flex:1">${escapeHtml(ans)}</div>
        <button type="button" class="btn danger" data-del-ans="${i}">ğŸ—‘</button>
      </label>`;
    }).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';

    // ì„ íƒ ë³€ê²½
    box.querySelectorAll('input[name="ansPick"]').forEach(r=>{
      r.addEventListener('change',(e)=>{
        raw.find(x=>x._idx===currentIdx).active = parseInt(e.target.value,10)||0;
      });
    });
    // ê°œë³„ ì‚­ì œ
    box.querySelectorAll('[data-del-ans]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const i = parseInt(btn.getAttribute('data-del-ans'),10);
        const q = raw.find(x=>x._idx===currentIdx);
        q.answers.splice(i,1);
        if((q.active||0)>=q.answers.length){ q.active=Math.max(0,q.answers.length-1); }
        renderAnswerList();
      });
    });

    // ìƒˆ ì •ë‹µ ì¶”ê°€
    document.getElementById('addAnsBtn').onclick = ()=>{
      const val = (document.getElementById('newAns').value||'').trim();
      if(!val) return;
      const q = raw.find(x=>x._idx===currentIdx);
      q.answers.push(val);
      q.active = q.answers.length-1; // ë°©ê¸ˆ ì¶”ê°€í•œ ê²ƒ ì‚¬ìš©
      document.getElementById('newAns').value='';
      renderAnswerList();
    };
  }

  /* ===== ìŠµë“ì™„ë£Œ ===== */
  document.getElementById('learnedBtn').onclick = ()=>{
    if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
    const q = raw.find(x=>x._idx===currentIdx);
    const prog = loadProgress();
    prog[currentUser] = prog[currentUser] || { learnedIds: [] };
    if(!prog[currentUser].learnedIds.includes(q._id)){
      prog[currentUser].learnedIds.push(q._id);
      saveProgress(prog);
    }
    closeQuestion();
    applyUserFilterAndRender(); // ëª©ë¡/ì¹´ìš´íŠ¸/í—¤ë”/ë­í‚¹ ê°±ì‹ 
  };

  /* ===== ìœ ì‚¬ë„(í† í° êµì§‘í•© Jaccard) ===== */
  function similarity(a,b){
    const sa=new Set(String(a).split(/\s+/).filter(Boolean));
    const sb=new Set(String(b).split(/\s+/).filter(Boolean));
    let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
    return inter/(sa.size+sb.size-inter||1);
  }

  /* ===== ë¶€íŒ… ===== */
  (async function(){
    await loadData();
    updateLeaderboardTable();
    // ìë™ ë¡œê·¸ì¸ ë³µì›(ì„ íƒì‚¬í•­): ìµœê·¼ ë¡œê·¸ì¸ ì‚¬ìš©ì ì €ì¥ì„ ì›í•˜ì‹œë©´ ì—¬ê¸°ì— ì €ì¥/ë³µì› ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
  })();
  </script>
</body>
</html>